<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meetup Chat & Booking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .user-selector {
            margin-bottom: 15px;
        }

        .user-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .create-request {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .create-request:hover {
            background: #0056b3;
        }

        .threads-list {
            flex: 1;
            overflow-y: auto;
        }

        .thread-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .thread-item:hover {
            background: #f8f9fa;
        }

        .thread-item.active {
            background: #e3f2fd;
            border-right: 3px solid #2196f3;
        }

        .thread-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .thread-preview {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-top: 5px;
        }

        .status-request { background: #fff3cd; color: #856404; }
        .status-booking { background: #d4edda; color: #155724; }
        .status-locked { background: #f8d7da; color: #721c24; }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 500;
        }

        .chat-status {
            font-size: 12px;
            color: #666;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.system {
            align-items: center;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.system .message-bubble {
            background: #e9ecef;
            color: #495057;
            font-style: italic;
            text-align: center;
        }

        .message.user .message-bubble {
            background: #007bff;
            color: white;
        }

        .message.other .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message-meta {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .message-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .message-input-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .message-input:focus {
            border-color: #007bff;
        }

        .send-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-button:hover {
            background: #0056b3;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .no-thread-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        .status-connecting { background: #fff3cd; color: #856404; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
        }

        .modal h3 {
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <!-- Create Request Modal -->
    <div id="createRequestModal" class="modal">
        <div class="modal-content">
            <h3>Create New Request</h3>
            <form id="createRequestForm">
                <div class="form-group">
                    <label for="eventId">Event ID:</label>
                    <input type="text" id="eventId" required>
                </div>
                <div class="form-group">
                    <label for="hostId">Host ID:</label>
                    <input type="text" id="hostId" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoAccept"> Auto-accept request
                    </label>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Request</button>
                </div>
            </form>
        </div>
    </div>

    <div class="sidebar">
        <div class="header">
            <div class="user-selector">
                <label for="userIdSelect">Select User:</label>
                <select id="userIdSelect">
                    <option value="">Select a user...</option>
                </select>
            </div>
            <button class="create-request" onclick="openCreateRequestModal()">Create Request</button>
        </div>
        <div class="threads-list" id="threadsList">
            <!-- Threads will be loaded here -->
        </div>
    </div>

    <div class="main-content">
        <div id="noThreadSelected" class="no-thread-selected">
            Select a thread to start chatting
        </div>
        
        <div id="chatInterface" style="display: none;">
            <div class="chat-header">
                <div>
                    <div class="chat-title" id="chatTitle">Thread</div>
                    <div class="chat-status" id="chatStatus">Loading...</div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="message-input-container">
                <form class="message-input-form" id="messageForm">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." disabled>
                    <button type="submit" class="send-button" id="sendButton" disabled>Send</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.currentUser = null;
                this.currentThread = null;
                this.websocket = null;
                this.threads = [];
                this.messages = new Map(); // thread_id -> messages array
                
                this.initializeApp();
            }

            async initializeApp() {
                await this.loadUsers();
                this.setupEventListeners();
                this.updateConnectionStatus('connecting');
            }

            async loadUsers() {
                try {
                    // First seed the database to get test users
                    const seedResponse = await fetch('/dev/seed');
                    const seedData = await seedResponse.json();
                    
                    const select = document.getElementById('userIdSelect');
                    select.innerHTML = '<option value="">Select a user...</option>';
                    
                    // Add the seeded users
                    const users = [
                        { id: seedData.guest_id, name: 'Test Guest' },
                        { id: seedData.host_id, name: 'Test Host' }
                    ];
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }

            setupEventListeners() {
                document.getElementById('userIdSelect').addEventListener('change', (e) => {
                    this.setCurrentUser(e.target.value);
                });

                document.getElementById('createRequestForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createRequest();
                });

                document.getElementById('messageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
            }

            async setCurrentUser(userId) {
                if (!userId) {
                    this.currentUser = null;
                    this.disconnectWebSocket();
                    this.clearUI();
                    return;
                }

                this.currentUser = userId;
                await this.loadThreads();
                this.connectWebSocket();
            }

            async loadThreads() {
                if (!this.currentUser) return;

                try {
                    const response = await fetch('/threads', {
                        headers: { 'X-User-Id': this.currentUser }
                    });
                    const data = await response.json();
                    
                    this.threads = data.threads;
                    this.renderThreads();
                } catch (error) {
                    console.error('Error loading threads:', error);
                }
            }

            renderThreads() {
                const container = document.getElementById('threadsList');
                container.innerHTML = '';

                this.threads.forEach(thread => {
                    const threadElement = document.createElement('div');
                    threadElement.className = 'thread-item';
                    threadElement.dataset.threadId = thread.id;
                    
                    const statusClass = thread.is_locked ? 'status-locked' : 
                                      thread.scope === 'booking' ? 'status-booking' : 'status-request';
                    
                    threadElement.innerHTML = `
                        <div class="thread-title">Thread ${thread.id.slice(0, 8)}</div>
                        <div class="thread-preview">Event: ${thread.event_id.slice(0, 8)}...</div>
                        <div class="thread-status ${statusClass}">
                            ${thread.is_locked ? 'Locked' : 
                              thread.scope === 'booking' ? 'Booking' : 'Request'}
                        </div>
                    `;
                    
                    threadElement.addEventListener('click', () => {
                        this.selectThread(thread.id);
                    });
                    
                    container.appendChild(threadElement);
                });
            }

            selectThread(threadId) {
                // Update UI
                document.querySelectorAll('.thread-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-thread-id="${threadId}"]`).classList.add('active');

                this.currentThread = threadId;
                this.showChatInterface();
                this.loadMessages(threadId);
            }

            showChatInterface() {
                document.getElementById('noThreadSelected').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'flex';
                
                const thread = this.threads.find(t => t.id === this.currentThread);
                if (thread) {
                    document.getElementById('chatTitle').textContent = `Thread ${thread.id.slice(0, 8)}`;
                    document.getElementById('chatStatus').textContent = 
                        thread.is_locked ? 'Thread locked' : 
                        thread.scope === 'booking' ? 'Booking confirmed' : 'Request pending';
                }
            }

            async loadMessages(threadId) {
                if (!this.currentUser) return;

                try {
                    const response = await fetch(`/threads/${threadId}/messages`, {
                        headers: { 'X-User-Id': this.currentUser }
                    });
                    const messages = await response.json();
                    
                    this.messages.set(threadId, messages);
                    this.renderMessages(threadId);
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            renderMessages(threadId) {
                const container = document.getElementById('messagesContainer');
                const messages = this.messages.get(threadId) || [];
                
                container.innerHTML = '';
                
                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${this.getMessageClass(message)}`;
                    
                    const time = new Date(message.created_at).toLocaleTimeString();
                    
                    messageElement.innerHTML = `
                        <div class="message-bubble">${message.body}</div>
                        <div class="message-meta">${time}</div>
                    `;
                    
                    container.appendChild(messageElement);
                });
                
                container.scrollTop = container.scrollHeight;
            }

            getMessageClass(message) {
                if (message.kind === 'system') return 'system';
                if (message.sender_id === this.currentUser) return 'user';
                return 'other';
            }

            async sendMessage() {
                if (!this.currentUser || !this.currentThread) return;

                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                if (!message) return;

                const clientMsgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                try {
                    const response = await fetch(`/threads/${this.currentThread}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': this.currentUser
                        },
                        body: JSON.stringify({
                            client_msg_id: clientMsgId,
                            body: message
                        })
                    });

                    if (response.ok) {
                        input.value = '';
                        // Message will be added via WebSocket
                    } else {
                        console.error('Error sending message:', await response.text());
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }

            connectWebSocket() {
                if (!this.currentUser || this.websocket) return;

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${this.currentUser}`;
                
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    this.updateConnectionStatus('connected');
                };
                
                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.websocket.onclose = () => {
                    this.updateConnectionStatus('disconnected');
                    this.websocket = null;
                    // Reconnect after 3 seconds
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.websocket.onerror = () => {
                    this.updateConnectionStatus('disconnected');
                };
            }

            disconnectWebSocket() {
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
            }

            handleWebSocketMessage(data) {
                if (data.type === 'new_message') {
                    const message = data.message;
                    const threadId = message.thread_id;
                    
                    // Add message to our cache
                    if (!this.messages.has(threadId)) {
                        this.messages.set(threadId, []);
                    }
                    this.messages.get(threadId).push(message);
                    
                    // Re-render if this is the current thread
                    if (threadId === this.currentThread) {
                        this.renderMessages(threadId);
                    }
                }
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status status-${status}`;
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }

            async createRequest() {
                const eventId = document.getElementById('eventId').value;
                const hostId = document.getElementById('hostId').value;
                const autoAccept = document.getElementById('autoAccept').checked;

                try {
                    const response = await fetch('/requests', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': this.currentUser
                        },
                        body: JSON.stringify({
                            event_id: eventId,
                            host_id: hostId,
                            auto_accept: autoAccept
                        })
                    });

                    if (response.ok) {
                        closeModal();
                        await this.loadThreads();
                        alert('Request created successfully!');
                    } else {
                        const error = await response.text();
                        alert('Error creating request: ' + error);
                    }
                } catch (error) {
                    console.error('Error creating request:', error);
                    alert('Error creating request: ' + error.message);
                }
            }

            clearUI() {
                document.getElementById('threadsList').innerHTML = '';
                document.getElementById('noThreadSelected').style.display = 'flex';
                document.getElementById('chatInterface').style.display = 'none';
                this.messages.clear();
            }
        }

        // Modal functions
        function openCreateRequestModal() {
            if (!window.chatApp.currentUser) {
                alert('Please select a user first');
                return;
            }
            document.getElementById('createRequestModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('createRequestModal').style.display = 'none';
            document.getElementById('createRequestForm').reset();
        }

        // Initialize the app
        window.chatApp = new ChatApp();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createRequestModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
