<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meetup Service - Five Panel Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 20px;
            height: 85vh;
        }
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            padding: 20px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        .participants-header { background: #4f46e5; }
        .organizers-header { background: #10b981; }
        .requests-header { background: #8b5cf6; }
        .events-header { background: #f59e0b; }
        .users-header { background: #ec4899; }
        
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 300px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message { background: #4f46e5; color: white; margin-left: auto; text-align: right; }
        .system-message { background: #e5e7eb; color: #374151; margin-right: auto; }
        .host-message { background: #10b981; color: white; margin-right: auto; }
        .organizer-message { background: #f59e0b; color: white; margin-right: auto; }
        
        .message-sender {
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .chat-input {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            outline: none;
            font-size: 16px;
        }
        .chat-input button {
            margin-left: 10px;
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .action-buttons {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .action-buttons button {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .action-buttons button.primary { background: #4f46e5; color: white; border-color: #4f46e5; }
        .action-buttons button.success { background: #10b981; color: white; border-color: #10b981; }
        .action-buttons button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        .action-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .user-selector { margin-bottom: 20px; }
        .user-selector select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; }
        
        /* Event Creation Form */
        .event-form {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Requests Overview Styles */
        .requests-overview {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .organizer-group {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .organizer-group-header {
            background: #e0e7ff;
            padding: 12px 16px;
            font-weight: bold;
            color: #3730a3;
            border-bottom: 1px solid #c7d2fe;
        }
        .event-group {
            border-bottom: 1px solid #e2e8f0;
        }
        .event-group:last-child { border-bottom: none; }
        .event-group-header {
            background: #f1f5f9;
            padding: 10px 16px;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
        }
        .event-group-content { padding: 12px 16px; }
        .request-item-compact {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .request-item-compact:last-child { margin-bottom: 0; }
        .request-info { flex: 1; }
        .request-user { font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .request-time { font-size: 12px; color: #64748b; }
        .request-actions-compact { display: flex; gap: 6px; }
        .request-actions-compact button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .approve-btn-compact { background: #10b981; color: white; }
        .decline-btn-compact { background: #ef4444; color: white; }
        .status-badge-compact {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }
        .status-submitted-compact { background: #fef3c7; color: #92400e; }
        .status-accepted-compact { background: #d1fae5; color: #065f46; }
        .status-declined-compact { background: #fee2e2; color: #991b1b; }
        
        /* Events Overview Styles */
        .events-overview {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .event-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .event-item:last-child { margin-bottom: 0; }
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .event-title-main {
            font-weight: bold;
            color: #1e293b;
            font-size: 16px;
        }
        .event-organizer {
            font-size: 14px;
            color: #64748b;
        }
        .event-details-main {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .event-participants {
            margin-top: 10px;
        }
        .participants-header {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .participant-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .participant-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .no-participants {
            color: #9ca3af;
            font-style: italic;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéâ Meetup Service - Five Panel Interface</h1>
        <p>Left: Event Participants | Middle: Event Creators | Right: Requests Overview | Far Right: Events Overview | Rightmost: User Creation</p>
    </div>
    
    <div class="main-container">
        <!-- LEFT PANEL: EVENT PARTICIPANTS -->
        <div class="panel">
            <div class="panel-header participants-header">üë• Event Participants</div>
            <div class="panel-content">
                <div class="sidebar">
                    <div class="user-selector">
                        <label for="userSelect">Act as User:</label>
                        <select id="userSelect">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <div class="user-selector">
                        <label for="eventSelect">Select Event:</label>
                        <select id="eventSelect">
                            <option value="">Loading events...</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="refreshEvents()" class="primary" style="padding: 8px 16px; font-size: 12px;">üîÑ Refresh Events</button>
                    </div>
                </div>
                <div class="chat-area">
                    <div class="chat-messages" id="participantChat">
                        
                    </div>
                    <div class="action-buttons" id="participantActions" style="display: none;">
                        <button onclick="requestToJoin()" class="primary" id="requestBtn">Request to Join Event</button>
                    </div>
                    <div class="chat-input" id="participantChatInput" style="display: none;">
                        <input type="text" id="participantInput" placeholder="Type your message..." onkeypress="handleParticipantKeyPress(event)">
                        <button onclick="sendParticipantMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIDDLE PANEL: EVENT CREATORS -->
        <div class="panel">
            <div class="panel-header organizers-header">üéØ Event Creators</div>
            <div class="panel-content">
                <div class="sidebar">
                    <div class="user-selector">
                        <label for="creatorSelect">Create Event as:</label>
                        <select id="creatorSelect">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                </div>
                <div class="event-form">
                    <h4>Create New Event</h4>
                    <form id="eventForm">
                        <button type="button" onclick="generateRandomEvent()" class="success" style="width: 100%; padding: 12px; margin-bottom: 15px;">üé≤ Generate Random Event</button>
                        <div class="form-group">
                            <label for="eventTitle">Event Title *</label>
                            <input type="text" id="eventTitle" placeholder="e.g., Morning Tennis Doubles" required>
                        </div>
                        <div class="form-group">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" placeholder="Describe your event..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventDate">Date *</label>
                                <input type="date" id="eventDate" required>
                            </div>
                            <div class="form-group">
                                <label for="eventTime">Time *</label>
                                <input type="time" id="eventTime" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventCapacity">Capacity *</label>
                                <input type="number" id="eventCapacity" min="1" max="100" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="eventActivity">Activity Type *</label>
                                <select id="eventActivity" required>
                                    <option value="tennis">Tennis</option>
                                    <option value="basketball">Basketball</option>
                                    <option value="yoga">Yoga</option>
                                    <option value="golf">Golf</option>
                                    <option value="running">Running</option>
                                    <option value="swimming">Swimming</option>
                                    <option value="hiking">Hiking</option>
                                    <option value="cycling">Cycling</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="eventLocation">Location</label>
                            <input type="text" id="eventLocation" placeholder="e.g., Central Park Tennis Courts">
                        </div>
                        <div class="form-group">
                            <label for="eventAddress">Address</label>
                            <input type="text" id="eventAddress" placeholder="Full address">
                        </div>
                        <div class="form-group">
                            <label for="eventTags">Tags</label>
                            <div id="tagSelector" style="border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; min-height: 40px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">
                                <span style="color: #6b7280; font-size: 14px;">Select tags...</span>
                            </div>
                            <div id="availableTags" style="margin-top: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; display: none;">
                                <!-- Available tags will be populated here -->
                            </div>
                            <button type="button" onclick="toggleTagSelector()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">
                                <span id="tagToggleText">Show Tags</span>
                            </button>
                        </div>
                        <button type="submit" class="primary" style="width: 100%; padding: 12px;">Create Event</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- THIRD PANEL: REQUESTS OVERVIEW -->
        <div class="panel">
            <div class="panel-header requests-header">üìã Requests Overview</div>
            <div class="panel-content">
                <div class="requests-overview" id="requestsOverview">
                    
                </div>
            </div>
        </div>

        <!-- FOURTH PANEL: EVENTS OVERVIEW -->
        <div class="panel">
            <div class="panel-header events-header">üìÖ Events Overview</div>
            <div class="panel-content">
                <div class="sidebar">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">All Events</h4>
                        <button onclick="refreshEventsOverview()" class="primary" style="padding: 6px 12px; font-size: 12px;">Refresh</button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label for="tagFilter" style="font-size: 12px; color: #374151; margin-bottom: 5px; display: block;">Filter by Tag:</label>
                        <select id="tagFilter" onchange="filterEventsByTag()" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <option value="">All Events</option>
                        </select>
                    </div>
                </div>
                <div class="events-overview" id="eventsOverview">
                    
                </div>
            </div>
        </div>

        <!-- FIFTH PANEL: USER CREATION -->
        <div class="panel">
            <div class="panel-header users-header">‚ûï User Creation</div>
            <div class="panel-content">
                <div class="user-form" style="padding: 20px;">
                    <h4>Create New User</h4>
                    <form id="userForm">
                        <button type="button" onclick="generateRandomUser()" class="success" style="width: 100%; padding: 12px; margin-bottom: 15px;">üé≤ Generate Random User</button>
                        <div class="form-group">
                            <label for="displayName">Display Name *</label>
                            <input type="text" id="displayName" name="displayName" placeholder="e.g., Jane Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="e.g., jane@example.com">
                        </div>
                        <button type="submit" class="primary" style="width: 100%; padding: 12px;">Create User</button>
                    </form>
                    <div id="recentUsers" style="margin-top: 20px;">
                        <h5>Recent Users</h5>
                        <div id="recentUsersList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="tagManagement" style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <h5>Tag Management</h5>
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="newTagName" placeholder="Tag name" style="width: 60%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 5px;">
                            <input type="color" id="newTagColor" value="#4f46e5" style="width: 20%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 5px;">
                            <button onclick="createTag()" style="padding: 8px 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">Create</button>
                        </div>
                        <div id="tagsList" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                            <!-- Tags will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUserId = null;
        let currentEventId = null;
        let users = [];
        let events = [];
        let requests = [];
        let currentRequest = null;
        let tags = [];
        let selectedTags = [];

        // User creation functions
        function generateRandomUser() {
            const names = [
                "Alex Johnson", "Sam Chen", "Jordan Smith", "Taylor Brown", "Casey Wilson",
                "Morgan Davis", "Riley Garcia", "Avery Martinez", "Quinn Anderson", "Blake Thomas",
                "Sage Rodriguez", "River White", "Phoenix Harris", "Skyler Clark", "Rowan Lewis",
                "Emery Walker", "Finley Hall", "Hayden Young", "Kai Allen", "Nova King"
            ];
            const emails = [
                "alex@example.com", "sam@example.com", "jordan@example.com", "taylor@example.com", "casey@example.com",
                "morgan@example.com", "riley@example.com", "avery@example.com", "quinn@example.com", "blake@example.com",
                "sage@example.com", "river@example.com", "phoenix@example.com", "skyler@example.com", "rowan@example.com",
                "emery@example.com", "finley@example.com", "hayden@example.com", "kai@example.com", "nova@example.com"
            ];
            
            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomEmail = emails[Math.floor(Math.random() * emails.length)];
            
            document.getElementById('displayName').value = randomName;
            document.getElementById('email').value = randomEmail;
        }

        // Random event data generators
        const eventTitles = [
            "Morning Tennis Doubles",
            "Basketball Pickup Game",
            "Sunset Yoga Session",
            "Golf Tournament",
            "Morning Run Group",
            "Swimming Workout",
            "Hiking Adventure",
            "Cycling Tour",
            "Beach Volleyball",
            "Rock Climbing Session",
            "Soccer Match",
            "Tennis Clinic",
            "Pilates Class",
            "CrossFit Workout",
            "Martial Arts Training",
            "Dance Workshop",
            "Boxing Session",
            "Badminton Tournament",
            "Squash Game",
            "Table Tennis Championship"
        ];

        const eventDescriptions = [
            "Join us for an exciting morning of tennis! All skill levels welcome.",
            "Come play some basketball with fellow enthusiasts. Bring your A-game!",
            "Relax and unwind with our peaceful sunset yoga session.",
            "Competitive golf tournament with prizes for top performers.",
            "Start your day right with our energizing morning run group.",
            "Get your heart pumping with our intensive swimming workout.",
            "Explore beautiful trails and enjoy nature on our hiking adventure.",
            "Cycle through scenic routes and discover new places together.",
            "Fun beach volleyball game - bring sunscreen and water!",
            "Challenge yourself with our rock climbing session for all levels.",
            "Friendly soccer match - cleats recommended but not required.",
            "Improve your tennis skills with our professional clinic.",
            "Strengthen your core with our invigorating Pilates class.",
            "High-intensity CrossFit workout to push your limits.",
            "Learn self-defense and get fit with our martial arts training.",
            "Express yourself through movement in our creative dance workshop.",
            "Boxing session for fitness and stress relief.",
            "Fast-paced badminton tournament with competitive spirit.",
            "Indoor squash game - great for cardio and strategy.",
            "Table tennis championship with prizes and bragging rights!"
        ];

        const locations = [
            "Central Park Tennis Courts",
            "Downtown Basketball Court",
            "Beachfront Yoga Studio",
            "Championship Golf Course",
            "Riverside Running Trail",
            "Olympic Swimming Pool",
            "Mountain View Hiking Trail",
            "City Cycling Route",
            "Sunset Beach Volleyball Court",
            "Indoor Rock Climbing Gym",
            "Community Soccer Field",
            "Tennis Academy Courts",
            "Modern Pilates Studio",
            "CrossFit Box Downtown",
            "Martial Arts Dojo",
            "Dance Studio Central",
            "Boxing Gym Westside",
            "Badminton Sports Center",
            "Squash Club Downtown",
            "Table Tennis Arena"
        ];

        const addresses = [
            "123 Main Street, Downtown",
            "456 Park Avenue, Midtown",
            "789 Beach Road, Waterfront",
            "321 Golf Drive, Countryside",
            "654 River Lane, Riverside",
            "987 Pool Street, Sports District",
            "147 Mountain View, Hillside",
            "258 Cycle Path, Urban Center",
            "369 Beach Boulevard, Coastal",
            "741 Climb Street, Adventure Zone",
            "852 Field Road, Sports Complex",
            "963 Court Avenue, Tennis District",
            "159 Studio Lane, Wellness Center",
            "357 Box Street, Fitness Quarter",
            "468 Dojo Way, Martial Arts Plaza",
            "579 Dance Boulevard, Arts District",
            "680 Gym Street, Training Center",
            "791 Badminton Court, Sports Hub",
            "802 Squash Lane, Athletic Complex",
            "913 Ping Pong Place, Recreation Center"
        ];

        function generateRandomEvent() {
            const randomTitle = eventTitles[Math.floor(Math.random() * eventTitles.length)];
            const randomDescription = eventDescriptions[Math.floor(Math.random() * eventDescriptions.length)];
            const randomLocation = locations[Math.floor(Math.random() * locations.length)];
            const randomAddress = addresses[Math.floor(Math.random() * addresses.length)];

            // Generate random date (next 1-30 days)
            const today = new Date();
            const randomDays = Math.floor(Math.random() * 30) + 1;
            const eventDate = new Date(today.getTime() + randomDays * 24 * 60 * 60 * 1000);
            const dateString = eventDate.toISOString().split("T")[0];

            // Generate random time (6 AM to 10 PM)
            const randomHour = Math.floor(Math.random() * 17) + 6; // 6-22
            const randomMinute = Math.floor(Math.random() * 4) * 15; // 0, 15, 30, 45
            const timeString = `${randomHour.toString().padStart(2, "0")}:${randomMinute.toString().padStart(2, "0")}`;

            // Generate random capacity (5-50)
            const randomCapacity = Math.floor(Math.random() * 46) + 5;

            // Get activity type from title
            let activityType = "tennis";
            if (randomTitle.toLowerCase().includes("basketball")) activityType = "basketball";
            else if (randomTitle.toLowerCase().includes("yoga")) activityType = "yoga";
            else if (randomTitle.toLowerCase().includes("golf")) activityType = "golf";
            else if (randomTitle.toLowerCase().includes("run")) activityType = "running";
            else if (randomTitle.toLowerCase().includes("swim")) activityType = "swimming";
            else if (randomTitle.toLowerCase().includes("hiking")) activityType = "hiking";
            else if (randomTitle.toLowerCase().includes("cycling")) activityType = "cycling";
            else if (randomTitle.toLowerCase().includes("volleyball")) activityType = "volleyball";
            else if (randomTitle.toLowerCase().includes("climbing")) activityType = "climbing";
            else if (randomTitle.toLowerCase().includes("soccer")) activityType = "soccer";
            else if (randomTitle.toLowerCase().includes("pilates")) activityType = "pilates";
            else if (randomTitle.toLowerCase().includes("crossfit")) activityType = "crossfit";
            else if (randomTitle.toLowerCase().includes("martial")) activityType = "martial_arts";
            else if (randomTitle.toLowerCase().includes("dance")) activityType = "dance";
            else if (randomTitle.toLowerCase().includes("boxing")) activityType = "boxing";
            else if (randomTitle.toLowerCase().includes("badminton")) activityType = "badminton";
            else if (randomTitle.toLowerCase().includes("squash")) activityType = "squash";
            else if (randomTitle.toLowerCase().includes("table tennis")) activityType = "table_tennis";

            // Fill the form
            document.getElementById("eventTitle").value = randomTitle;
            document.getElementById("eventDescription").value = randomDescription;
            document.getElementById("eventDate").value = dateString;
            document.getElementById("eventTime").value = timeString;
            document.getElementById("eventCapacity").value = randomCapacity;
            document.getElementById("eventActivity").value = activityType;
            document.getElementById("eventLocation").value = randomLocation;
            document.getElementById("eventAddress").value = randomAddress;
        }

        async function loadData() {
            try {
                console.log('Loading data...');
                
                const usersResponse = await fetch(`${API_BASE}/users`);
                users = await usersResponse.json();
                console.log('Users loaded:', users);
                
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">Select a user...</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.display_name} (ID: ${user.id})`;
                    userSelect.appendChild(option);
                });

                const creatorSelect = document.getElementById('creatorSelect');
                creatorSelect.innerHTML = '<option value="">Select a creator...</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.display_name} (ID: ${user.id})`;
                    creatorSelect.appendChild(option);
                });

                await loadEvents();
                await loadRequests(); // Load requests from backend
                await loadTags(); // Load tags
                console.log('Data loaded successfully');
                updateRequestsOverview();
                updateEventsOverview();
                generateRandomEvent(); // Pre-fill with random data on load
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadEvents() {
            const eventsResponse = await fetch(`${API_BASE}/events`);
            events = await eventsResponse.json();
            console.log('Events loaded:', events);
            
            const eventSelect = document.getElementById('eventSelect');
            eventSelect.innerHTML = '<option value="">Select an event...</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.title} - ${new Date(event.starts_at).toLocaleString()} (${event.capacity} spots)`;
                eventSelect.appendChild(option);
            });
        }

        async function loadRequests() {
            try {
                const requestsResponse = await fetch(`${API_BASE}/requests/all`);
                requests = await requestsResponse.json();
                console.log('Requests loaded:', requests);
            } catch (error) {
                console.error('Error loading requests:', error);
                requests = []; // Fallback to empty array
            }
        }

        async function refreshEvents() {
            await loadEvents();
            
        }

        
        // Event-specific chat storage
        let eventChats = {};
        let currentThreadId = null;
        let websocket = null;
        
        function getEventChatKey(userId, eventId) {
            return `user_${userId}_event_${eventId}`;
        }
        
        function loadEventChat(userId, eventId) {
            const chatKey = getEventChatKey(userId, eventId);
            const chatDiv = document.getElementById('participantChat');
            
            if (eventChats[chatKey]) {
                chatDiv.innerHTML = eventChats[chatKey];
            } else {
                chatDiv.innerHTML = '';
                eventChats[chatKey] = '';
            }
        }
        
        function saveEventChat(userId, eventId) {
            const chatKey = getEventChatKey(userId, eventId);
            const chatDiv = document.getElementById('participantChat');
            eventChats[chatKey] = chatDiv.innerHTML;
        }

        // Chat access control
        async function checkChatAccess() {
            if (!currentUserId || !currentEventId) return false;
            
            // Check if user is the event creator (host)
            const selectedEvent = events.find(e => e.id == currentEventId);
            if (selectedEvent && selectedEvent.created_by == currentUserId) {
                return true;
            }
            
            // Check if user is an accepted participant
            const userRequest = requests.find(r => r.user_id == currentUserId && r.event_id == currentEventId);
            if (userRequest && userRequest.status === 'ACCEPTED') {
                return true;
            }
            
            return false;
        }

        // Get thread ID for current event
        async function getThreadIdForEvent() {
            if (!currentUserId || !currentEventId) return null;
            
            try {
                const response = await fetch(`${API_BASE}/threads`, {
                    headers: {
                        "X-User-Id": currentUserId.toString()
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Find thread for this event
                    const thread = data.threads.find(t => t.event_id == currentEventId);
                    return thread ? thread.id : null;
                }
            } catch (error) {
                console.error('Error getting threads:', error);
            }
            
            return null;
        }

        // Load messages for current thread
        async function loadThreadMessages() {
            if (!currentThreadId) return;
            
            try {
                const response = await fetch(`${API_BASE}/threads/${currentThreadId}/messages`, {
                    headers: {
                        "X-User-Id": currentUserId.toString()
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    const chatDiv = document.getElementById('participantChat');
                    chatDiv.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addParticipantMessage(msg.body, msg.kind === 'system' ? 'system' : 'user', msg.sender_id);
                    });
                    
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // WebSocket connection management
        function connectWebSocket() {
            if (websocket) {
                websocket.close();
            }
            
            if (!currentUserId) return;
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                console.log('WebSocket connected');
                if (currentThreadId) {
                    joinThread(currentThreadId);
                }
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'new_message') {
                    // Only add message if it's not from the current user (to avoid duplicates)
                    if (data.message.sender_id !== currentUserId) {
                        addParticipantMessage(data.message.body, data.message.kind === 'system' ? 'system' : 'user', data.message.sender_id);
                    }
                }
            };
            
            websocket.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function joinThread(threadId) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'join_thread',
                    thread_id: threadId
                }));
            }
        }

        function leaveThread(threadId) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'leave_thread',
                    thread_id: threadId
                }));
            }
        }
        
        async function selectParticipantUser() {
            const userSelect = document.getElementById('userSelect');
            currentUserId = userSelect.value;
            console.log('Participant user selected:', currentUserId);
            
            // Connect WebSocket for this user
            connectWebSocket();
            
            // Load chat for this user and current event
            if (currentUserId && currentEventId) {
                await initializeChat();
            }
            
            updateParticipantUI();
        }
        
        async function selectEvent() {
            const eventSelect = document.getElementById('eventSelect');
            currentEventId = eventSelect.value;
            console.log('Event selected:', currentEventId);
            
            // Save current chat and load chat for this event
            if (currentUserId && currentEventId) {
                await initializeChat();
            }
            
            updateParticipantUI();
        }

        function selectParticipantUser() {
            const userSelect = document.getElementById('userSelect');
            currentUserId = userSelect.value;
            console.log('Participant user selected:', currentUserId);
            
            if (currentUserId && currentEventId) {
                
            }
        }

        function selectParticipantEvent() {
            const eventSelect = document.getElementById('eventSelect');
            const eventId = eventSelect.value;
            
            if (!eventId) {
                currentEventId = null;
                return;
            }
            
            const event = events.find(e => e.id == eventId);
            if (!event) return;
            
            console.log('Selecting participant event:', event);
            currentEventId = event.id;
            
            const userRequest = requests.find(r => r.user_id == currentUserId && r.event_id == currentEventId);
            
            if (userRequest) {
                currentRequest = userRequest;
                updateParticipantUI();
            } else {
                currentRequest = null;
                document.getElementById('participantActions').style.display = 'flex';
                document.getElementById('requestBtn').disabled = false;
                document.getElementById('rsvpGoingBtn').disabled = true;
                document.getElementById('rsvpMaybeBtn').disabled = true;
                document.getElementById('participantChatInput').style.display = 'none';
                
            }
        }

        // Initialize chat for current user and event
        async function initializeChat() {
            if (!currentUserId || !currentEventId) return;
            
            // Check if user has chat access
            const hasAccess = await checkChatAccess();
            
            if (hasAccess) {
                // Get thread ID and load messages
                currentThreadId = await getThreadIdForEvent();
                if (currentThreadId) {
                    await loadThreadMessages();
                    joinThread(currentThreadId);
                }
            } else {
                // Clear chat if no access
                const chatDiv = document.getElementById('participantChat');
                chatDiv.innerHTML = '';
                currentThreadId = null;
            }
        }

        async function updateParticipantUI() {
            if (!currentUserId || !currentEventId) {
                document.getElementById('participantActions').style.display = 'none';
                document.getElementById('participantChatInput').style.display = 'none';
                return;
            }
            
            // Check if user has chat access
            const hasAccess = await checkChatAccess();
            
            if (hasAccess) {
                document.getElementById('participantActions').style.display = 'flex';
                document.getElementById('participantChatInput').style.display = 'flex';
                
                // Update button states based on request status
                if (currentRequest) {
                    if (currentRequest.status === 'ACCEPTED') {
                        document.getElementById('requestBtn').disabled = true;
                    } else if (currentRequest.status === 'SUBMITTED') {
                        document.getElementById('requestBtn').disabled = true;
                    } else if (currentRequest.status === 'DECLINED') {
                        document.getElementById('requestBtn').disabled = true;
                    }
                } else {
                    // No request yet, show request button
                    document.getElementById('requestBtn').disabled = false;
                }
            } else {
                document.getElementById('participantActions').style.display = 'flex';
                document.getElementById('participantChatInput').style.display = 'none';
                
                // Show request button if no request exists
                if (!currentRequest) {
                    document.getElementById('requestBtn').disabled = false;
                } else {
                    document.getElementById('requestBtn').disabled = true;
                }
            }
        }

        function addParticipantMessage(content, type = 'user', senderId = null) {
            const messagesDiv = document.getElementById('participantChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Get sender name if senderId is provided
            let senderName = '';
            if (senderId && type !== 'system') {
                const sender = users.find(u => u.id == senderId);
                senderName = sender ? sender.display_name : 'Unknown User';
            }
            
            // Create message content with sender info
            if (senderName && type !== 'system') {
                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                senderSpan.textContent = `${senderName}: `;
                senderSpan.style.fontWeight = 'bold';
                senderSpan.style.color = type === 'user' ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.7)';
                
                const contentSpan = document.createElement('span');
                contentSpan.textContent = content;
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(contentSpan);
            } else {
                messageDiv.textContent = content;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleParticipantKeyPress(event) {
            if (event.key === 'Enter') {
                sendParticipantMessage();
            }
        }

        async function sendParticipantMessage(customMessage = null) {
            if (!currentUserId || !currentEventId) {
                addParticipantMessage('‚ùå Please select both a user and an event first.', 'system');
                return;
            }

            // Check if user has access to chat (host or accepted participant)
            if (!await checkChatAccess()) {
                addParticipantMessage('‚ùå You can only chat if you are the host or an accepted participant of this event.', 'system');
                return;
            }

            const input = document.getElementById('participantInput');
            const message = customMessage || input.value.trim();
            
            if (!message) return;
            
            // Get the thread ID for this event
            const threadId = await getThreadIdForEvent();
            if (!threadId) {
                addParticipantMessage('‚ùå No chat thread found for this event.', 'system');
                return;
            }

            try {
                // Send message to backend
                const response = await fetch(`${API_BASE}/threads/${threadId}/messages`, {
                    method: 'POST',
                    headers: {
                        "X-User-Id": currentUserId.toString(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_msg_id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        body: message
                    })
                });
                
                if (response.ok) {
                    const messageData = await response.json();
                    // Add message to UI immediately for better UX
                    addParticipantMessage(messageData.body, 'user', currentUserId);
                    input.value = '';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addParticipantMessage(`‚ùå Failed to send message: ${error.message}`, 'system');
            }
        }

        async function requestToJoin() {
            if (!currentUserId || !currentEventId) {
                addParticipantMessage('‚ùå Please select both a user and an event first.', 'system');
                return;
            }

            // Find the selected event to get the correct host_id
            const selectedEvent = events.find(e => e.id == currentEventId);
            if (!selectedEvent) {
                addParticipantMessage('‚ùå Selected event not found. Please refresh and try again.', 'system');
                return;
            }

            // Check if user already has a request for this event
            const existingRequest = requests.find(r => r.user_id == currentUserId && r.event_id == currentEventId);
            if (existingRequest) {
                addParticipantMessage('‚ùå You already have a request for this event.', 'system');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/requests`, {
                    method: 'POST',
                    headers: {
                        "X-User-Id": currentUserId.toString(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_id: currentEventId, // Keep as string, don't convert to int
                        host_id: selectedEvent.created_by, // Use the actual event creator as host
                        auto_accept: false
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentRequest = {
                        id: data.request_id,
                        event_id: currentEventId,
                        user_id: currentUserId,
                        host_id: selectedEvent.created_by,
                        status: data.status || 'SUBMITTED',
                        user_name: users.find(u => u.id == currentUserId)?.display_name || 'Unknown',
                        event_title: selectedEvent.title
                    };
                    requests.push(currentRequest);
                    
                    addParticipantMessage('‚úÖ Request to join event submitted successfully!', 'system');
                    updateParticipantUI();
                    updateRequestsOverview();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to create request');
                }
            } catch (error) {
                console.error('Error creating request:', error);
                addParticipantMessage(`‚ùå Sorry, there was an error creating your request: ${error.message}`, 'system');
            }
        }


        // EVENT CREATION
        document.getElementById('eventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const creatorId = document.getElementById('creatorSelect').value;
            if (!creatorId) {
                alert('Please select a creator first!');
                return;
            }

            const eventData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                starts_at: new Date(document.getElementById('eventDate').value + 'T' + document.getElementById('eventTime').value).toISOString(),
                capacity: parseInt(document.getElementById('eventCapacity').value),
                activity_type: document.getElementById('eventActivity').value,
                location: document.getElementById('eventLocation').value,
                address: document.getElementById('eventAddress').value,
                created_by: creatorId,
                tag_ids: selectedTags
            };

            try {
                const response = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: {
                        "X-User-Id": creatorId,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(eventData)
                });
                
                if (response.ok) {
                    const newEvent = await response.json();
                    events.push(newEvent);
                    
                    // Refresh all event lists
                    await loadEvents();
                    updateEventsOverview();
                    
                    // Clear form
                    document.getElementById('eventForm').reset();
                    document.getElementById('eventCapacity').value = 10;
                    
                    alert('‚úÖ Event created successfully!');
                } else {
                    throw new Error('Failed to create event');
                }
            } catch (error) {
                console.error('Error creating event:', error);
                alert('‚ùå Sorry, there was an error creating the event. Please try again.');
            }
        });

        function updateRequestsOverview() {
            const overviewDiv = document.getElementById('requestsOverview');
            overviewDiv.innerHTML = '';
            
            if (requests.length === 0) {
                overviewDiv.innerHTML = '<div class="message system-message">No pending requests.</div>';
                return;
            }
            
            // Group requests by organizer (host_id) and then by event
            const groupedRequests = {};
            requests.forEach(request => {
                const hostId = request.host_id || 1;
                const hostName = users.find(u => u.id == hostId)?.display_name || `Organizer ${hostId}`;
                const eventName = events.find(e => e.id == request.event_id)?.title || `Event ${request.event_id}`;
                
                if (!groupedRequests[hostId]) {
                    groupedRequests[hostId] = {
                        hostName: hostName,
                        events: {}
                    };
                }
                
                if (!groupedRequests[hostId].events[request.event_id]) {
                    groupedRequests[hostId].events[request.event_id] = {
                        eventName: eventName,
                        requests: []
                    };
                }
                
                groupedRequests[hostId].events[request.event_id].requests.push(request);
            });
            
            // Create HTML structure
            Object.keys(groupedRequests).forEach(hostId => {
                const hostGroup = groupedRequests[hostId];
                
                const organizerGroupDiv = document.createElement('div');
                organizerGroupDiv.className = 'organizer-group';
                
                const organizerHeader = document.createElement('div');
                organizerHeader.className = 'organizer-group-header';
                organizerHeader.textContent = `üë§ ${hostGroup.hostName} (${hostId})`;
                organizerGroupDiv.appendChild(organizerHeader);
                
                Object.keys(hostGroup.events).forEach(eventId => {
                    const eventGroup = hostGroup.events[eventId];
                    
                    const eventGroupDiv = document.createElement('div');
                    eventGroupDiv.className = 'event-group';
                    
                    const eventHeader = document.createElement('div');
                    eventHeader.className = 'event-group-header';
                    eventHeader.textContent = `üìÖ ${eventGroup.eventName} (${eventGroup.requests.length} request${eventGroup.requests.length !== 1 ? 's' : ''})`;
                    eventGroupDiv.appendChild(eventHeader);
                    
                    const eventContent = document.createElement('div');
                    eventContent.className = 'event-group-content';
                    
                    eventGroup.requests.forEach(request => {
                        const requestDiv = document.createElement('div');
                        requestDiv.className = 'request-item-compact';
                        requestDiv.innerHTML = `
                            <div class="request-info">
                                <div class="request-user">${request.user_name}</div>
                                <div class="request-time">${new Date().toLocaleString()}</div>
                            </div>
                            <div class="request-actions-compact">
                                <span class="status-badge-compact status-${request.status.toLowerCase()}-compact">${request.status}</span>
                                <button class="approve-btn-compact" onclick="approveRequestFromOverview('${request.id}')" ${request.status !== 'SUBMITTED' ? 'disabled' : ''}>‚úì</button>
                                <button class="decline-btn-compact" onclick="declineRequestFromOverview('${request.id}')" ${request.status !== 'SUBMITTED' ? 'disabled' : ''}>‚úó</button>
                            </div>
                        `;
                        eventContent.appendChild(requestDiv);
                    });
                    
                    eventGroupDiv.appendChild(eventContent);
                    organizerGroupDiv.appendChild(eventGroupDiv);
                });
                
                overviewDiv.appendChild(organizerGroupDiv);
            });
        }

        function updateEventsOverview() {
            const overviewDiv = document.getElementById('eventsOverview');
            overviewDiv.innerHTML = '';
            
            if (events.length === 0) {
                overviewDiv.innerHTML = '<div class="message system-message">No events available.</div>';
                return;
            }
            
            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                
                const organizer = users.find(u => u.id == event.created_by);
                const organizerName = organizer ? organizer.display_name : `User ${event.created_by}`;
                
                // Get participants from requests
                const eventRequests = requests.filter(r => r.event_id == event.id && r.status === 'ACCEPTED');
                const participants = eventRequests.map(r => r.user_name);
                
                eventDiv.innerHTML = `
                    <div class="event-header">
                        <div class="event-title-main">${event.title}</div>
                        <div class="event-organizer">üë§ ${organizerName}</div>
                    </div>
                    <div class="event-details-main">
                        üìÖ ${new Date(event.starts_at).toLocaleString()}<br>
                        üë• Capacity: ${event.capacity}<br>
                        üèÉ Activity: ${event.activity_type}<br>
                        üìç ${event.location || 'Location TBD'}
                    </div>
                    ${event.tags && event.tags.length > 0 ? `
                    <div class="event-tags" style="margin-top: 10px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Tags:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            ${event.tags.map(tag => `
                                <span style="background: ${tag.color || '#e5e7eb'}; color: ${getContrastColor(tag.color || '#e5e7eb')}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    ${tag.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    <div class="event-participants">
                        <div class="participants-header">Participants (${participants.length}/${event.capacity}):</div>
                        <div class="participant-list">
                            ${participants.length > 0 
                                ? participants.map(p => `<span class="participant-tag">${p}</span>`).join('')
                                : '<span class="no-participants">No participants yet</span>'
                            }
                        </div>
                    </div>
                `;
                
                overviewDiv.appendChild(eventDiv);
            });
        }

        async function refreshEventsOverview() {
            await loadEvents();
            await loadRequests();
            await loadTags();
            updateEventsOverview();
        }

        async function approveRequestFromOverview(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request) {
                console.error('Request not found:', requestId);
                return;
            }

            try {
                // Make API call to approve the request
                const response = await fetch(`${API_BASE}/requests/${requestId}/act`, {
                    method: 'POST',
                    headers: {
                        "X-User-Id": request.host_id.toString(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'accept'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update the request status
                    request.status = data.status || 'ACCEPTED';
                    
                    // Update UI
                    updateRequestsOverview();
                    updateEventsOverview();
                    
                    // If this is the current user's request, update their UI
                    if (currentUserId == request.user_id && currentEventId == request.event_id) {
                        currentRequest = request;
                        updateParticipantUI();
                        addParticipantMessage('‚úÖ Your request has been approved! You can now chat.', 'system');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to approve request');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert(`‚ùå Failed to approve request: ${error.message}`);
            }
        }

        async function declineRequestFromOverview(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request) {
                console.error('Request not found:', requestId);
                return;
            }

            try {
                // Make API call to decline the request
                const response = await fetch(`${API_BASE}/requests/${requestId}/act`, {
                    method: 'POST',
                    headers: {
                        "X-User-Id": request.host_id.toString(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'decline'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update the request status
                    request.status = data.status || 'DECLINED';
                    
                    // Update UI
                    updateRequestsOverview();
                    updateEventsOverview();
                    
                    // If this is the current user's request, update their UI
                    if (currentUserId == request.user_id && currentEventId == request.event_id) {
                        currentRequest = request;
                        updateParticipantUI();
                        addParticipantMessage('‚ùå Sorry, your request was declined. You can try requesting a different event.', 'system');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to decline request');
                }
            } catch (error) {
                console.error('Error declining request:', error);
                alert(`‚ùå Failed to decline request: ${error.message}`);
            }
        }

        // User form event listener
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const displayName = document.getElementById('displayName').value;
            const email = document.getElementById('email').value;
            
            if (!displayName) {
                alert('Please enter a display name');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        display_name: displayName,
                        email: email || null
                    })
                });
                
                if (response.ok) {
                    const newUser = await response.json();
                    addParticipantMessage(`‚úÖ User "${displayName}" created successfully!`, 'system');
                    
                    // Clear form
                    document.getElementById('displayName').value = '';
                    document.getElementById('email').value = '';
                    
                    // Refresh users list
                    await loadData();
                    updateRecentUsersList(newUser);
                } else {
                    throw new Error('Failed to create user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                addParticipantMessage('‚ùå Failed to create user. Please try again.', 'system');
            }
        });

        function updateRecentUsersList(newUser) {
            const recentUsersList = document.getElementById('recentUsersList');
            const userDiv = document.createElement('div');
            userDiv.style.cssText = 'padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; background: #f9fafb;';
            userDiv.innerHTML = `
                <strong>${newUser.display_name}</strong><br>
                <small>ID: ${newUser.id}</small>
                ${newUser.email ? `<br><small>Email: ${newUser.email}</small>` : ''}
            `;
            recentUsersList.insertBefore(userDiv, recentUsersList.firstChild);
            
            // Keep only last 5 users
            while (recentUsersList.children.length > 5) {
                recentUsersList.removeChild(recentUsersList.lastChild);
            }
        }

        // Tag management functions
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        async function loadTags() {
            try {
                const response = await fetch(`${API_BASE}/tags`);
                tags = await response.json();
                console.log('Tags loaded:', tags);
                updateTagsList();
                updateAvailableTags();
                updateTagFilter();
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        function updateTagFilter() {
            const tagFilterSelect = document.getElementById('tagFilter');
            tagFilterSelect.innerHTML = '<option value="">All Events</option>';
            
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.name;
                option.textContent = tag.name;
                tagFilterSelect.appendChild(option);
            });
        }

        async function filterEventsByTag() {
            const tagFilter = document.getElementById('tagFilter').value;
            
            try {
                let url = `${API_BASE}/events`;
                if (tagFilter) {
                    url += `?tag_filter=${encodeURIComponent(tagFilter)}`;
                }
                
                const response = await fetch(url);
                events = await response.json();
                console.log('Filtered events loaded:', events);
                updateEventsOverview();
            } catch (error) {
                console.error('Error filtering events:', error);
            }
        }

        function updateTagsList() {
            const tagsListDiv = document.getElementById('tagsList');
            if (tags.length === 0) {
                tagsListDiv.innerHTML = '<div style="color: #6b7280; font-style: italic;">No tags created yet</div>';
                return;
            }

            tagsListDiv.innerHTML = tags.map(tag => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 5px; background: #f9fafb;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${tag.color || '#e5e7eb'}; color: ${getContrastColor(tag.color || '#e5e7eb')}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                            ${tag.name}
                        </span>
                        ${tag.description ? `<span style="color: #6b7280; font-size: 12px;">${tag.description}</span>` : ''}
                    </div>
                    <button onclick="deleteTag('${tag.id}')" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                </div>
            `).join('');
        }

        function updateAvailableTags() {
            const availableTagsDiv = document.getElementById('availableTags');
            if (tags.length === 0) {
                availableTagsDiv.innerHTML = '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">No tags available</div>';
                return;
            }

            availableTagsDiv.innerHTML = tags.map(tag => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 5px; cursor: pointer; background: ${selectedTags.includes(tag.id) ? '#e0e7ff' : 'white'};" 
                     onclick="toggleTagSelection('${tag.id}')">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${tag.color || '#e5e7eb'}; color: ${getContrastColor(tag.color || '#e5e7eb')}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                            ${tag.name}
                        </span>
                        ${tag.description ? `<span style="color: #6b7280; font-size: 12px;">${tag.description}</span>` : ''}
                    </div>
                    <span style="color: #6b7280; font-size: 12px;">${selectedTags.includes(tag.id) ? '‚úì' : ''}</span>
                </div>
            `).join('');
        }

        function toggleTagSelector() {
            const availableTagsDiv = document.getElementById('availableTags');
            const toggleText = document.getElementById('tagToggleText');
            
            if (availableTagsDiv.style.display === 'none') {
                availableTagsDiv.style.display = 'block';
                toggleText.textContent = 'Hide Tags';
            } else {
                availableTagsDiv.style.display = 'none';
                toggleText.textContent = 'Show Tags';
            }
        }

        function toggleTagSelection(tagId) {
            if (selectedTags.includes(tagId)) {
                selectedTags = selectedTags.filter(id => id !== tagId);
            } else {
                selectedTags.push(tagId);
            }
            updateAvailableTags();
            updateTagSelector();
        }

        function updateTagSelector() {
            const tagSelectorDiv = document.getElementById('tagSelector');
            
            if (selectedTags.length === 0) {
                tagSelectorDiv.innerHTML = '<span style="color: #6b7280; font-size: 14px;">Select tags...</span>';
                return;
            }

            const selectedTagObjects = tags.filter(tag => selectedTags.includes(tag.id));
            tagSelectorDiv.innerHTML = selectedTagObjects.map(tag => `
                <span style="background: ${tag.color || '#e5e7eb'}; color: ${getContrastColor(tag.color || '#e5e7eb')}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                    ${tag.name}
                    <button onclick="toggleTagSelection('${tag.id}')" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 14px; padding: 0; margin-left: 4px;">√ó</button>
                </span>
            `).join('');
        }

        async function createTag() {
            const name = document.getElementById('newTagName').value.trim();
            const color = document.getElementById('newTagColor').value;
            
            if (!name) {
                alert('Please enter a tag name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        color: color,
                        description: ''
                    })
                });

                if (response.ok) {
                    const newTag = await response.json();
                    tags.push(newTag);
                    updateTagsList();
                    updateAvailableTags();
                    
                    // Clear form
                    document.getElementById('newTagName').value = '';
                    document.getElementById('newTagColor').value = '#4f46e5';
                    
                    console.log('Tag created successfully:', newTag);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to create tag');
                }
            } catch (error) {
                console.error('Error creating tag:', error);
                alert(`Failed to create tag: ${error.message}`);
            }
        }

        async function deleteTag(tagId) {
            if (!confirm('Are you sure you want to delete this tag? This will remove it from all events.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tags/${tagId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    tags = tags.filter(tag => tag.id !== tagId);
                    selectedTags = selectedTags.filter(id => id !== tagId);
                    updateTagsList();
                    updateAvailableTags();
                    updateTagSelector();
                    console.log('Tag deleted successfully');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to delete tag');
                }
            } catch (error) {
                console.error('Error deleting tag:', error);
                alert(`Failed to delete tag: ${error.message}`);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });

        // Initialize
        document.getElementById('userSelect').addEventListener('change', selectParticipantUser);
        document.getElementById('eventSelect').addEventListener('change', selectEvent);
        loadData();
    </script>
</body>
</html>
